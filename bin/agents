#!/usr/bin/env bash
#
# agents - Project scaffolding CLI for multi-agent development
#
# Universal configuration that works with Claude Code, Gemini CLI, and Codex CLI.
#
# Architecture:
#   .agents/           Source of truth (modular, editable)
#     PROJECT.md       Project-specific context
#     OS.md            AI operating system
#     TOOLS.md         Available tools and capabilities
#
#   AGENTS.md          Generated (concatenation of .agents/*)
#   CLAUDE.md          Symlink → AGENTS.md
#   GEMINI.md          Symlink → AGENTS.md
#

set -euo pipefail

VERSION="0.2.0"

# Resolve symlinks to find actual installation location
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
TEMPLATES_DIR="${SCRIPT_DIR}/../templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

# ============================================================
# Helpers
# ============================================================

log_info() {
    echo -e "${BLUE}→${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}⚠${NC} $1"
}

log_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

# ============================================================
# Commands
# ============================================================

cmd_version() {
    echo "agents v${VERSION}"
}

cmd_help() {
    cat << 'EOF'
agents - Universal project scaffolding for AI coding agents

USAGE:
    agents <command> [options]

COMMANDS:
    init [name]     Create new project with agent configuration
    build           Regenerate AGENTS.md from .agents/* sources
    upgrade         Update templates (OS.md, TOOLS.md) and rebuild
    update          Update agents CLI itself from GitHub
    list            List available template modules
    version         Show version information
    help            Show this help message

EXAMPLES:
    agents init my-project     # Create new project
    agents build               # Rebuild after editing .agents/*
    agents upgrade             # Get latest OS.md and TOOLS.md

ARCHITECTURE:
    Source files (edit these):
    .agents/
    ├── PROJECT.md     # Your project context
    ├── OS.md          # AI operating system
    └── TOOLS.md       # Tool definitions

    Generated files (don't edit):
    AGENTS.md          # Concatenated output (for Codex CLI)
    CLAUDE.md          # Symlink → AGENTS.md (for Claude Code)
    GEMINI.md          # Symlink → AGENTS.md (for Gemini CLI)

WORKFLOW:
    1. agents init my-project
    2. Edit .agents/PROJECT.md
    3. agents build
    4. All three CLIs see the same configuration

EOF
}

cmd_build() {
    local target_dir="${1:-.}"

    # Check we're in an agents project
    if [[ ! -d "$target_dir/.agents" ]]; then
        log_error "No .agents/ directory found"
        exit 1
    fi

    log_info "Building AGENTS.md..."

    # Concatenate in order: PROJECT, OS, TOOLS
    {
        echo "<!-- Generated by agents-init. Edit files in .agents/ then run 'agents build' -->"
        echo ""

        if [[ -f "$target_dir/.agents/PROJECT.md" ]]; then
            cat "$target_dir/.agents/PROJECT.md"
            echo ""
            echo "---"
            echo ""
        fi

        if [[ -f "$target_dir/.agents/OS.md" ]]; then
            cat "$target_dir/.agents/OS.md"
            echo ""
            echo "---"
            echo ""
        fi

        if [[ -f "$target_dir/.agents/TOOLS.md" ]]; then
            cat "$target_dir/.agents/TOOLS.md"
        fi
    } > "$target_dir/AGENTS.md"

    log_success "AGENTS.md"

    # Create/update symlinks
    ln -sf "AGENTS.md" "$target_dir/CLAUDE.md"
    log_success "CLAUDE.md → AGENTS.md"

    ln -sf "AGENTS.md" "$target_dir/GEMINI.md"
    log_success "GEMINI.md → AGENTS.md"

    echo ""
    log_success "Build complete"
}

cmd_init() {
    local project_name=""
    local interactive=false
    local target_dir="."

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -i|--interactive)
                interactive=true
                shift
                ;;
            -h|--help)
                cmd_help
                exit 0
                ;;
            *)
                project_name="$1"
                shift
                ;;
        esac
    done

    # Interactive mode
    if [[ "$interactive" == true ]]; then
        echo -e "${BOLD}agents init${NC} - Interactive Mode"
        echo ""
        read -rp "Project name (leave empty for current dir): " project_name
    fi

    # Determine target directory
    if [[ -n "$project_name" ]]; then
        target_dir="$project_name"
        if [[ -d "$target_dir" ]]; then
            log_error "Directory '$target_dir' already exists"
            exit 1
        fi
        mkdir -p "$target_dir"
        log_info "Created directory: $target_dir"
    fi

    # Check if already initialized
    if [[ -f "$target_dir/AGENTS.md" ]] || [[ -d "$target_dir/.agents" ]]; then
        log_error "Project already initialized (AGENTS.md or .agents/ exists)"
        exit 1
    fi

    # Create .agents directory
    mkdir -p "$target_dir/.agents"
    log_info "Created .agents/ directory"

    # Copy source templates
    log_info "Copying templates..."

    cp "$TEMPLATES_DIR/PROJECT.md" "$target_dir/.agents/PROJECT.md"
    log_success ".agents/PROJECT.md"

    cp "$TEMPLATES_DIR/OS.md" "$target_dir/.agents/OS.md"
    log_success ".agents/OS.md"

    cp "$TEMPLATES_DIR/TOOLS.md" "$target_dir/.agents/TOOLS.md"
    log_success ".agents/TOOLS.md"

    # Build the concatenated output
    echo ""
    cmd_build "$target_dir"

    # Summary
    echo ""
    echo -e "${GREEN}${BOLD}✓ Project scaffolded successfully${NC}"
    echo ""
    echo "  Next steps:"
    echo "    1. Edit .agents/PROJECT.md to describe your project"
    echo "    2. Run 'agents build' to regenerate AGENTS.md"
    echo "    3. Start working with Claude, Gemini, or Codex"
    echo ""

    if [[ -n "$project_name" ]]; then
        echo "  cd $project_name"
    fi
}

cmd_upgrade() {
    # Check we're in an agents project
    if [[ ! -d ".agents" ]]; then
        log_error "Not in an agents project (no .agents/ found)"
        exit 1
    fi

    log_info "Upgrading templates..."

    # Update OS.md
    cp "$TEMPLATES_DIR/OS.md" ".agents/OS.md"
    log_success ".agents/OS.md"

    # Update TOOLS.md
    cp "$TEMPLATES_DIR/TOOLS.md" ".agents/TOOLS.md"
    log_success ".agents/TOOLS.md"

    # Skip PROJECT.md (user content)
    log_warn "Skipped .agents/PROJECT.md (user content)"

    # Rebuild
    echo ""
    cmd_build "."

    echo ""
    log_success "Upgrade complete"
}

cmd_update() {
    local repo_url="https://github.com/pentaxis93/agents-init.git"
    local tmp_dir
    tmp_dir="$(mktemp -d)"

    log_info "Fetching latest version..."

    if ! git clone --quiet "$repo_url" "$tmp_dir" 2>/dev/null; then
        log_error "Failed to clone repository"
        rm -rf "$tmp_dir"
        exit 1
    fi

    log_info "Installing update..."

    if ! "$tmp_dir/install.sh" 2>/dev/null; then
        log_error "Installation failed"
        rm -rf "$tmp_dir"
        exit 1
    fi

    rm -rf "$tmp_dir"

    echo ""
    log_success "Updated to latest version"
    agents version
}

cmd_list() {
    echo -e "${BOLD}Source templates (.agents/):${NC}"
    echo ""
    echo "  PROJECT.md   Project context (user edits this)"
    echo "  OS.md        AI operating system"
    echo "  TOOLS.md     Tool definitions"
    echo ""
    echo -e "${BOLD}Generated files:${NC}"
    echo ""
    echo "  AGENTS.md    Concatenated output (Codex CLI)"
    echo "  CLAUDE.md    Symlink → AGENTS.md (Claude Code)"
    echo "  GEMINI.md    Symlink → AGENTS.md (Gemini CLI)"
    echo ""
}

# ============================================================
# Main
# ============================================================

main() {
    if [[ $# -eq 0 ]]; then
        cmd_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        init)
            cmd_init "$@"
            ;;
        build)
            cmd_build "."
            ;;
        upgrade)
            cmd_upgrade
            ;;
        update)
            cmd_update
            ;;
        list)
            cmd_list
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo "Run 'agents help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
